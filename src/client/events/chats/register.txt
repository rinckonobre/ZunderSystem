import { BreakInteraction, DocumentPlayer, Event, Firestore, ServerManager, client, config } from "@/app";
import { systemRegister, systemRecords, findRole } from "@/app/functions";
import { registers, registries } from "@/config/jsons";
import { ChannelType } from "discord.js";

const playerColl = new Firestore("players");

const blackListChars = [
    "@", "/", "*", "-", "&", "!", "<", ">", "#",
    ":", ";", "(", ")", "$", "%", "`", "[", "]", "+",
    "=",
];

export default new Event({
    name: "messageCreate", 
    async run(message){
        if (message.channel.type != ChannelType.GuildText ||
            message.channel.name != config.guild.channels.register ||
            message.guild?.id != client.mainGuildID ||
            !message.member || message.member.user.bot ||
            !message.inGuild()
        ) return;
        
        const { guild, member, content } = message;

        if (content.includes(" ")) {
            new BreakInteraction(message, "Digite seu nick sem espa√ßos");
            return;
        }

        for (const char of blackListChars) {
            if (content.includes(char)) {
                new BreakInteraction(message, `N√£o utilize caracteres especiais para se registrar!
                O nick que voc√™ enviou cont√©m \`${char}\` `);
                return;
            }
        }

        message.delete().catch(() => {});

        const memberData = await playerColl.getDocData(member.id) as DocumentPlayer | undefined;
        if (memberData && memberData.registry) {
            client.emit("guildMemberAdd", member);
            return;
        }

        systemRegister.create(member, content);

        const memberRole = findRole(guild, registries.discord.roles[1].name);
        // const memberRole = findRole(guild, registers.discord.find(r => r.level == 1)!.name);
        if (memberRole) member.roles.add(memberRole);

        systemRecords.send(guild, {
            system: {
                title: "üìù Registro", color: config.colors.primary, style: "SIMPLE"
            },
            details: `Novo membro registrado: ${member} **${member.user.tag}**
            Nick: \`${content}\``,
            mention: member,
            staff: client,
        });
    }
});